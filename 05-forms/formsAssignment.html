<!DOCTYPE html>
<html lang="en">

<head>
    <!-- #region Sabio Code - You can Fold this region to remove it from sight -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="Sabio Coding Bootcamp" />
    <meta itemprop="image" content="https://sabio.la/Sabio.png">
    <link rel="shortcut icon" href="https://sabio.la/Sabio.png">
    <link rel="icon" type="image/png" href="https://sabio.la/Sabio.png" />
    <!-- Do Not Change the HTML title or anything between this line and the line with the 💘's -->
    <title>PW Execise Template</title>
    <link href="https://pw.sabio.la/dist/all-site.css" rel="stylesheet" />
    <script src="https://pw.sabio.la/api/js/site"></script>


    <!-- #endregion -->
    <!-- I 💘 Code, You 💘 Code, We all 💘 Code -->

    <script src="https://unpkg.com/axios@0.19.2/dist/axios.min.js"></script>
    <script src="formsService.js"></script>

    <!-- 💡 All your CSS in here -->
    <style>
        .btn-small {
            height: 25px;
            font-size: x-small;
        }
        
        .isSelected {
            border: 1px solid green;
        }
        
        .hasErrors {
            border: 1px solid red;
        }
    </style>


    <script id="teamTemplate" type="text/template">
        <div class="card">
            <div class="card-body">
                <span class="card-city"></span>
                <span class="card-team"></span>
                <p class="card-sport"></p>
                <button type="button" class="editTeam btn btn-default btn-success btn-small">Edit</button>
                <button type="button" class="deleteTeam btn btn-default btn-danger btn-small">Delete</button>
            </div>
        </div>
    </script>


</head>

<body class="sabio" data-ins="pw-00">
    <!-- Do Not Edit or Remove this nav element -->
    <nav class="do-not-remove navbar navbar-expand-md navbar-dark bg-dark sabio"></nav>


    <main class="container">

        <p>Sports Teams Form</p>

        <div class="container">

            <div id="errors"></div>

            <form id="formSports">

                <input type="hidden" id="teamId" name="teamId" disabled class="d-none" value="-1">

                <div class="form-group">
                    <label for="team">Team Name:</label>
                    <input type="text" class="form-control" id="team" name="team" required minlength="2" maxlength="50">
                    <small id="teamhelp" class="form-text text-muted">Team Name is required (2-50).</small>
                </div>
                <div class="form-group">
                    <label for="sport">Sport:</label>
                    <input type="text" class="form-control" id="sport" name="sport" required minlength="2" maxlength="50">
                    <small id="sporthelp" class="form-text text-muted">Sport type is required (2-50).</small>
                </div>
                <div class="form-group">
                    <label for="city">City:</label>
                    <input type="text" class="form-control" id="city" name="city" required minlength="2" maxlength="50">
                    <small id="cityhelp" class="form-text text-muted">City name is required (2-50).</small>
                </div>

                <!-- NOTE Observe this nuance of submit, validation, etc -->
                <button type="button" name="clear" id="clear" onclick="clearForm();" class="btn btn-default btn-warning">Reset</button>

                <button type="submit" name="submit" id="submit" onclick="onAddNewSportsTeamButtonClick();" class="btn btn-default btn-primary">Add</button>

                <button type="button" name="update" id="update" onclick="onUpdateSportsTeamButtonClick();" class="btn btn-default btn-info">Update</button>

                <button type="button" name="render" id="render" onclick="onRenderButtonClick();" class="btn btn-default btn-success">Render</button>

            </form>

        </div>

        <hr>

        <div class="card-columns">
            <div class="clone-container">
            </div>
        </div>

    </main>

    <!-- Do Not Edit or Remove this footer element -->
    <footer class="do-not-remove container-fluid footer mx-auto  fb-targert sabio d-none">
        <p class="text-center">© Sabio.la 2019</p>
    </footer>

    <!--👇🏻 All your JavaScript code goes below here inside this script tag 👇🏻 -->
    <script id="candidateCode">
        var services = {
            blogsService: blogsService,
            teamsService: teamsService
        }

        function startUp() {

            console.log("startUp...");

            emptyErrors();

            clearForm();

            wireUpEvents();

            console.log("before test");

            var result = test()
                .then(function(data) {
                    console.log("random test result...", data);
                })
                .catch(function(data) {
                    console.log("random test result...", data);
                })

            console.log("after test");

            console.log(result);

        }

        /*

            interesting behaviour to observe... 
            
                when the something promise is rejected (catch case), it seems to exit the function and return to the catch that called it
                when the something promise is fullfilled, it seems to return to the then with proper results
        */
        async function test() {
            var result = await something();
            console.log("inside random test result...", result);
            return result;
        }

        // Test function that returns error result 50% of the time
        function something() {
            return new Promise(function(resolve, reject) {
                var random = Math.random();
                if (random > .5) {
                    resolve({
                        name: 'object name ' + Date.now(),
                        status: 'success'
                    });
                } else {
                    reject("error message " + Date.now()); //reject(new Error("Error"));
                }
            });
        }



        /*

        NOTES - POSSIBLE FUTURE CODE IMPLEMENTATIONS

            // resultSet = response.data.items.filter(onlyBasketball);

            // function onlyBasketball(team, option) {
            //     consider lowercase/uppercase implications
            //     return team.sport.indexOf("Basketball") > -1;
            // }

        */


        function onGetAllTeamsSuccess(response) {
            var resultSet = response.data.items;
            processArrayByMapping(resultSet);
            return resultSet;

            /*
                BELOW CODE OPTIMIZED/REFACTORED BY THE CODE ABOVE

                    // var teamsArray = response.data.items;

                    // teamsArray.forEach(team => {
                    //     console.log(team);
                    //     var testTemplate = getTemplate();

                    //     // --------THE ENCLOSED CODE WAS REFACTORED BY 'modifyTemplate(template,team)'---------
                    //     // testTemplate = modifyTemplate(testTemplate, {
                    //     //     'team': team.team,
                    //     //     'city': team.city,
                    //     //     'sport': team.sport
                    //     // });
                    //     // --------THE ENCLOSED CODE WAS REFACTORED BY 'modifyTemplate(template,team)'---------
                    //     testTemplate = modifyTemplate(testTemplate, team);
                    //     $(".clone-container").append(testTemplate);
                    // });                

            */

        }

        function onGetAllTeamsError(response) {
            console.warn({
                error: response
            })

            return response;
        }

        function wireUpEvents() {

            console.log("wireUpEvents...");

            $('.clone-container').on("click", ".deleteTeam", onDeleteTeamClicked);
            $('.clone-container').on("click", ".editTeam", onEditTeamClicked);

            $("#formSports").submit(function(event) {
                event.preventDefault();
            });

            clearForm();
        }

        // function updateView() {

        //     // todo // TODO get this working without timeout -- rely on callback/promise/async
        //     // todo // TODO get this working without timeout -- rely on callback/promise/async
        //     // todo // TODO get this working without timeout -- rely on callback/promise/async

        //     // setTimeout(function() {
        //     //     renderView();
        //     // }, 1500);

        //     renderView();

        // }

        function onDeleteTeamClicked(event) {
            event.preventDefault();

            console.log("onDeleteTeamClicked...", selectedId);

            var selected = $(event.target.closest(".card"));
            var selectedId = selected.attr("data-id");

            deleteTeam(selectedId);

            console.log("after delete team success");

            $(".card[data-id='" + selectedId + "']").remove();

        }



        function selectCardById(selectedId) {
            $(".isSelected").removeClass("isSelected");
            $(".card[data-id='" + selectedId + "']").addClass("isSelected");
        }

        // TODO limit business logic in click events, make functions to do the work
        // TODO limit business logic in click events, make functions to do the work
        function onEditTeamClicked(event) {

            event.preventDefault();

            console.log("onEditTeamClicked...", event.target.closest(".card"));

            var selectedCard = $(event.target.closest(".card"));

            var selectedId = selectedCard.attr("data-id");

            //$(".isSelected").removeClass("isSelected");
            //selectedCard.toggleClass("isSelected");

            selectCardById(selectedId);

            console.log("edit selected...", selectedId);

            var objParse = JSON.parse(selectedCard.attr("data"));
            $('#team').val(objParse.team);
            $('#sport').val(objParse.sport);
            $('#city').val(objParse.city);

            $('#teamId').val(selectedId); // hidden field holding current selected id

            emptyErrors();

            window.scrollTo(0, 0);
        }


        /*


        */
        function getTemplate() {
            var template = $('#teamTemplate').html()
            return $(template);
        }

        function getExistingTemplateById(selectedId) {
            return $(".card[data-id='" + selectedId + "']").eq(0);
        }

        /* Initial raw version of populating html template */

        // function modifyTemplate(template, objProperties) {
        //     template.find('.card-team').text(objProperties.team);
        //     template.find('.card-sport').text(objProperties.sport);
        //     template.find('.card-city').text(objProperties.city);
        //     return template;
        // }


        /*


        */
        function modifyTemplate(template, id, team) {
            template.attr("data-id", id); // useful for individual access with unique id identifier
            template.attr("data", JSON.stringify(team)); // overkill to keep entire object properties here
            template.find('.card-team').text(team.team);
            template.find('.card-sport').text(team.sport);
            template.find('.card-city').text(team.city);
            return template;
        }

        function clearForm() {
            console.log("reset...");

            $("#formSports")[0].reset();
            $('#teamId').val(-1);
            $(".isSelected").removeClass("isSelected");

            emptyErrors();

            //$('.hasErrors').removeClass('hasErrors');

            $('#team').focus();

            return true;
        }

        function getAndTrimFormText(selector) {
            var strOut = $(selector).val();
            strOut = strOut.trim();
            $(selector).val(strOut);
            console.log(' value for ' + selector + ' is [' + strOut + ']');
            return strOut;
        }

        function formValidation() {

            var hasErrors = false;

            var errors = [];

            emptyErrors();

            var teamName = getAndTrimFormText('#team');
            var sportName = getAndTrimFormText('#sport');
            var cityName = getAndTrimFormText('#city');

            console.log(teamName, sportName, cityName);

            // NOTE - better implementation is to use IN-CONTEXT Error Messages, add hasError class

            if ((teamName == null) || (teamName == "") || (teamName.length < 2) || (teamName.length > 50)) {
                hasErrors = true;
                errors.push("Team name must be 2-50 characters."); // todo consider in context-error messages
                $('#team').addClass('hasErrors');
            } else {
                $('#team').removeClass('hasErrors');
            }

            if ((sportName.length < 2) || (sportName.length > 50)) {
                hasErrors = true;
                errors.push("Sport name must be 2-50 characters.");
                $('#sport').addClass('hasErrors');
            } else {
                $('#sport').removeClass('hasErrors');
            }

            if ((cityName.length < 2) || (cityName.length > 50)) {
                hasErrors = true;
                errors.push("City name must be 2-50 characters.");
                $('#city').addClass('hasErrors');
            } else {
                $('#city').removeClass('hasErrors');
            }

            return {
                hasErrors: hasErrors,
                errors: errors
            }

        }

        // TODO - organize, order and sort/group functions for readability

        // NOTE - consider a views object instead of all these global hoisted functions
        // NOTE - framwork like react will help here so no worries



        function emptyErrors() {
            $('#errors').empty();

            $('.hasErrors').removeClass('hasErrors');
        }

        function showFormValidationErrors(formValidationResult) {

            formValidationResult.errors.forEach((error) => {
                $('#errors').append(`<p class="alert alert-danger">${error}</p>`);
            });

        }

        // POSSIBLY no need for async , await yet

        async function renderView() {

            $(".clone-container").empty();

            let result = await teamsService.getAll()
                .then(onGetAllTeamsSuccess)
                .catch(onGetAllTeamsError);

            console.log("result of renderView() ...", result);

            return result;
        }

        async function getAndRenderAll() {
            let result = await renderView();
            console.log("result of getAndRenderAll() ...", result);
            return result;
        }

        async function onRenderButtonClick() {
            let result = await getAndRenderAll(); // returns promise
            console.log("onRenderButtonClick", result);
        }

        async function getOneTeamAndAdd(teamId) { // get and append one team, called after successful add to backend

            // call backend to /api/teams/<id>

            // use results to append

            let result = teamsService.get(teamId)
                .then(onGetOneTeamSuccess)
                .catch(onGetOneTeamError)

            console.log("getOneTeamAndAdd...", result);

            return result;

        }

        function onGetOneTeamSuccess(data) {
            console.log("onGetOneTeamSuccess", data);
            console.log(data);
            appendOneTeam(data.data.item.id, data.data.item);
        }

        function onGetOneTeamError(response) {
            console.log("onGetOneTeamError", response);
            console.warn(response);
        }




        function appendOneTeam(id, team) {
            if (!team.id) {
                team.id = id
            }
            var arrayOfOne = [team];
            let singleJqTemplate = arrayOfOne.map(mapSingleItem);
            $(".clone-container").append(singleJqTemplate);
        }

        function mapSingleItem(team) {
            console.log(team);
            var testTemplate = getTemplate();
            var id = team.id;
            testTemplate = modifyTemplate(testTemplate, id, team);
            return testTemplate;
        }

        function processArrayByMapping(arrayOfData) {
            let arrayofJqTemplates = arrayOfData.map(mapSingleItem);
            $(".clone-container").append(arrayofJqTemplates);
        }

        // todo move most of this business logic into function and out of click handler

        function onAddNewSportsTeamButtonClick() {

            console.log("onAddNewSportsTeamButtonClick...");

            var selectedId = $('#teamId').val(); // hidden form value that is set based on selecting edit in card view

            if (selectedId != -1) { // todo - this is possibly clumsy use of variables for state information
                if (confirm("Warning. You have an existing element selected. Are you sure you want to ADD instead of UPDATE ?") == false) {
                    return false;
                }
            }

            var formValidationResult = formValidation();

            if (formValidationResult.hasErrors) {
                showFormValidationErrors(formValidationResult);
                return false; // form isn't posted/submitted
            }

            // add new sport // note - trimming and setting proper values is done on a call within the validation function

            var newTeam = {
                team: $('#team').val(),
                sport: $('#sport').val(),
                city: $('#city').val()
            }

            console.log(`addTeam(newTeam); will be invoked with ${JSON.stringify(newTeam)}`);

            let result = addTeam(newTeam);

            console.log("add team result...", result);

        }

        function onUpdateSportsTeamButtonClick() {

            console.log("onUpdateSportsTeamButtonClick...");

            var formValidationResult = formValidation();

            if (formValidationResult.hasErrors) {
                showFormValidationErrors(formValidationResult);
                return false;
            }

            var updateId = $('#teamId').val();

            if (updateId < 0) {
                $('#errors').append(`<p class="alert alert-danger">You must select an existing team to UPDATE, or use ADD to create a new team.</p>`);

                return false;
            }

            var updateObject = {
                team: $('#team').val(),
                sport: $('#sport').val(),
                city: $('#city').val()
            }

            console.log(`Update will be invoked with id: ${updateId} data: ${JSON.stringify(updateObject)}`);

            updateTeam(updateId, updateObject);

            // TODO update on DOM using updateId and updateObject without complete refresh

            var updateTemplate = getExistingTemplateById(updateId);

            // TODO this modify should be within the success of the update.. because if it fails the dom might still be updated.. yikes!
            modifyTemplate(updateTemplate, updateId, updateObject);

        }

        var addTeam = (team) => {

            console.log("addTeam", team);

            var newTeam = {
                team: team.team,
                sport: team.sport,
                city: team.city
            };

            return teamsService.add(newTeam)
                .then(onAddTeamSuccess)
                .catch(onAddTeamError);
        }

        var onAddTeamSuccess = data => {
            console.log("onAddTeamSuccess", data);
            console.log("Added new id: ", data.data.item);
            clearForm();


            getOneTeamAndAdd(data.data.item); // gets newly added and appends
            //getAndRenderAll(); // this is now handled individually by call above

            //alert("onAddTeamSuccess " + JSON.stringify(data));
            return data;

        }

        var onAddTeamError = err => {
            console.warn("onAddTeamError", err);
            alert("onAddTeamError " + JSON.stringify(err));
            return err;
        }

        // TODO - ON EDIT - Once the data is updated in the form, you should allow the user to click a second "Update" button or the same Submit button from the original form so that they can initiate an actual update.

        var updateTeam = (teamId, team) => {
            console.log("updateTeam");
            var payload = {
                team: team.team,
                sport: team.sport,
                city: team.city
            };

            return teamsService.update(teamId, payload)
                .then(onUpdateTeamSuccess)
                .catch(onUpdateTeamError);
        }

        var onUpdateTeamSuccess = data => {
            console.log("onUpdateTeamSuccess", data);
            console.log(data);
            clearForm();

            // todo handle in DOM update here

            //getAndRenderAll();
            //alert("onUpdateTeamSuccess " + JSON.stringify(data));
            return data;
        }

        var onUpdateTeamError = err => {
            console.warn("onUpdateTeamError", err);
            alert("onUpdateTeamError " + JSON.stringify(err));
            return err;
        }

        // TODO - It should remove the entity from the database and the DOM when the operation is successful, not before.

        var deleteTeam = (teamId) => {

            console.log("deleteTeam", teamId); // teamId = 235151523512; // FORCE ERROR CHECK

            return teamsService.delete(teamId)
                .then(onDeleteTeamSuccess)
                .catch(onDeleteTeamError);
        }

        var onDeleteTeamSuccess = data => {
            console.log("onDeleteTeamSuccess", data);
            console.log(data);
            clearForm();
            //getAndRenderAll(); // this is now handled individually upon delete success
            //alert("onDeleteTeamSuccess " + JSON.stringify(data));
            return data;
        }

        var onDeleteTeamError = err => {
            console.warn("onDeleteTeamError", err);
            alert("onDeleteTeamError " + JSON.stringify(err));
            return err;
        }

        //---------------------------------------------------------------------

        function blogsDemo() {

            var newBlog = {
                "authorId": 770304984,
                "title": "Title Of Blog " + Date.now(),
                "content": "This is my blog content."
            }

            var updatedBlog = {
                "id": 1529585106,
                "authorId": 770304984,
                "title": "Updated Blog Title " + Date.now(),
                "content": "Updated Content. " + Date.now()
            }

            var blogIdToGet = 1529585106;

            blogsService.getAll()
                .then(onGetBlogsSuccess)
                .catch(onGetBlogsError);

            blogsService.add(newBlog)
                .then(onAddBlogSuccess)
                .catch(onAddBlogError);

            blogsService.get(blogIdToGet)
                .then(onGetBlogSuccess)
                .catch(onGetBlogError);

            blogsService.update(updatedBlog)
                .then(onUpdateBlogSuccess)
                .catch(onUpdateBlogError);

            update(updatedBlog.id, updatedBlog);

            getById(blogIdToGet);

        }

        function update(id, payload) {
            return blogsService.update(payload);
        }

        function getById(id) {
            return blogsService.get(id);
        }

        function onUpdateBlogSuccess(response) {
            console.log({
                updateRespone: response
            })
        }

        function onUpdateBlogError(response) {
            console.log({
                error: response
            })
        }

        function onGetBlogSuccess(response) {
            console.log({
                blog: response.data.item
            })
        }

        function onGetBlogError(response) {
            console.log({
                error: response
            })
        }

        function onAddBlogSuccess(response) {
            console.log({
                blogId: response.data.item
            })
        }

        function onAddBlogError(response) {
            console.warn({
                error: response
            })
        }

        function onGetBlogsSuccess(response) {
            console.log({
                blogs: response.data.items
            })
        }

        function onGetBlogsError(response) {
            console.warn({
                error: response
            })
        }
    </script>
    <!-- 🛑 Do Not Write Any Code Below here -->
</body>

</html>